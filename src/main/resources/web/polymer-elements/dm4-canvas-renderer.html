<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="dm4-canvas-topic.html">

<dom-module id="dm4-canvas-renderer">

    <template>
        <canvas width="{{size.width}}" height="{{size.height}}"></canvas>
        <template is="dom-repeat" items="{{topicmap.topics}}">
            <dm4-canvas-topic topic={{item}}></dm4-canvas-topic>
        </template>
    </template>

    <script>
        Polymer({
            is: "dm4-canvas-renderer",

            ASSOC_WIDTH: 4,
            DEFAULT_ASSOC_COLOR: "#b2b2b2",

            properties: {
                topicmap: {
                    type: Object,
                    observer: "_drawAssociations"
                },
                size: {
                    type: Object,
                    observer: "_canvasSizeChanged"
                }
            },

            listeners: {
                "topic-move": "_drawAssociations"
            },

            ready: function() {
                this.ctx = this.$$("canvas").getContext("2d");
            },

            // --- Local DOM ---

            _canvasSizeChanged: function() {
                console.log("canvas renderer size changed", this.size)
                this._drawAssociations();
            },

            // --- Canvas Drawing ---

            _drawAssociations: function() {
                // at the time of the first resize event no topicmap is set
                if (!this.topicmap) {
                    return;
                }
                //
                this.ctx.clearRect(0, 0, this.ctx.canvas.width, this.ctx.canvas.height);   // TODO: topicmap translation
                for (var i = 0, assoc; assoc = this.topicmap.assocs[i]; i++) {
                    var p1 = this._getTopicPos(assoc.role_1.topic_id);
                    var p2 = this._getTopicPos(assoc.role_2.topic_id);
                    this._drawLine(p1.x, p1.y, p2.x, p2.y, this.ASSOC_WIDTH, this.DEFAULT_ASSOC_COLOR);
                }
            },

            _drawLine: function(x1, y1, x2, y2, width, color) {
                this.ctx.lineWidth = width
                this.ctx.strokeStyle = color
                this.ctx.beginPath();
                this.ctx.moveTo(x1, y1);
                this.ctx.lineTo(x2, y2);
                this.ctx.stroke();
            },

            // --- Model Access ---

            _getTopic: function(id) {
                for (var i = 0, topic; topic = this.topicmap.topics[i]; i++) {
                    if (topic.id == id) {
                        return topic;
                    }
                }
            },

            _getTopicPos: function(id) {
                var viewProps = this._getTopic(id).view_props;
                return {x: this._getX(viewProps), y: this._getY(viewProps)};
            },

            _getX: function(viewProps) {
                return viewProps["dm4.topicmaps.x"];
            },

            _getY: function(viewProps) {
                return viewProps["dm4.topicmaps.y"];
            }
        });
    </script>

</dom-module>
