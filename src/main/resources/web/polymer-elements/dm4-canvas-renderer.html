<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="dm4-canvas-topic.html">

<dom-module id="dm4-canvas-renderer">

    <style>
        div {
            position: absolute;
            right: 0;
            bottom: 0;
        }
    </style>

    <template>
        <canvas width="[[size.width]]" height="[[size.height]]"></canvas>
        <div style$="[[_getTopicLayerStyle(_translation)]]">
            <template is="dom-repeat" items="[[topicmap.topics]]">
                <dm4-canvas-topic topic="[[item]]" dm4="[[dm4]]"></dm4-canvas-topic>
            </template>
        </div>
    </template>

    <script>
        Polymer({
            is: "dm4-canvas-renderer",

            ASSOC_WIDTH: 4,
            DEFAULT_ASSOC_COLOR: "#b2b2b2",

            properties: {

                /**
                 * The rendered topicmap.
                 */
                topicmap: {
                    type: Object,
                    observer: "_topicmapChanged"
                },

                /**
                 * The canvas size in pixel.
                 * An object with `width` and `height` properties.
                 */
                size: {
                    type: Object,
                    observer: "_canvasSizeChanged"
                },

                /**
                 * Global state.
                 * See `dm4-webclient`.
                 */
                dm4: {
                    type: Object
                },

                /**
                 * The canvas translation in pixel.
                 * An object with `x` and `y` properties.
                 */
                _translation: {
                    type: Object,
                    value: {x: 0, y: 0},
                    observer: "_translationChanged"
                },

                /**
                 * The canvas 2D drawing context.
                 */
                _ctx: {
                    type: Object
                }
            },

            listeners: {
                "topic-moving": "_drawCanvas",
                "track": "_trackCanvas"
            },

            ready: function() {
                this._ctx = this.$$("canvas").getContext("2d");
            },

            // --------------------------------------------------------------------------------------------- Private API

            _topicmapChanged: function(topicmap) {
                this._translation = this._getTranslation(topicmap);
                console.log("_topicmapChanged: setting up canvas translation", this._translation);
                this._drawCanvas();
            },

            // --- Local DOM ---

            _trackCanvas: function(e) {
                switch (e.detail.state) {
                case "start":
                    // console.log("canvas track start");
                    break;
                case "track":
                    this._translation = {
                        x: this._translation.x + e.detail.ddx,
                        y: this._translation.y + e.detail.ddy
                    }
                    // this.fire("topic-moving", {topic: this.topic});
                    break;
                case "end":
                    // console.log("canvas track end");
                    this._setTranslation(this.topicmap, this._translation);
                    this.fire("topicmap-move", {translation: this._translation});
                    break;
                }
            },

            _canvasSizeChanged: function(size) {
                console.log("canvas size changed", size);
                // Note: once its size has changed a canvas looses its translation
                this._ctx.translate(this._translation.x, this._translation.y);
                this._drawCanvas();
            },

            _translationChanged: function(translation, oldTranslation) {
                // Note: at initialization the old value is undefined
                if (oldTranslation) {
                    var dx = translation.x - oldTranslation.x;
                    var dy = translation.y - oldTranslation.y;
                    // console.log("canvas translation changed", translation, "-->", dx, dy);
                    this._ctx.translate(dx, dy);
                    this._drawCanvas();
                }
            },

            _getTopicLayerStyle: function(translation) {
                return "top: " + translation.y + "px; left: " + translation.x + "px;";
            },

            // --- Canvas Drawing ---

            _drawCanvas: function() {
                // at the time of the first resize event no topicmap is set
                if (!this.topicmap) {
                    return;
                }
                //
                this._ctx.clearRect(-this._translation.x, -this._translation.y, this.size.width, this.size.height);
                this._drawAssociations();
            },

            _drawAssociations: function() {
                for (var i = 0, assoc; assoc = this.topicmap.assocs[i]; i++) {
                    var p1 = this._getTopicPos(assoc.role_1.topic_id);
                    var p2 = this._getTopicPos(assoc.role_2.topic_id);
                    this._drawLine(p1.x, p1.y, p2.x, p2.y, this.ASSOC_WIDTH, this.DEFAULT_ASSOC_COLOR);
                }
            },

            _drawLine: function(x1, y1, x2, y2, width, color) {
                this._ctx.lineWidth = width
                this._ctx.strokeStyle = color
                this._ctx.beginPath();
                this._ctx.moveTo(x1, y1);
                this._ctx.lineTo(x2, y2);
                this._ctx.stroke();
            },

            // --- Model Access ---

            _getTopic: function(id) {
                for (var i = 0, topic; topic = this.topicmap.topics[i]; i++) {
                    if (topic.id == id) {
                        return topic;
                    }
                }
            },

            _getTopicPos: function(id) {
                var viewProps = this._getTopic(id).view_props;
                return {x: this._getX(viewProps), y: this._getY(viewProps)};
            },

            _getX: function(viewProps) {
                return viewProps["dm4.topicmaps.x"];
            },

            _getY: function(viewProps) {
                return viewProps["dm4.topicmaps.y"];
            },

            // ---

            _getTranslation: function(topicmap) {
                var _translation = topicmap.info.childs["dm4.topicmaps.state"].childs["dm4.topicmaps.translation"];
                return {
                    x: _translation.childs["dm4.topicmaps.translation_x"].value,
                    y: _translation.childs["dm4.topicmaps.translation_y"].value
                }
            },

            _setTranslation: function(topicmap, translation) {
                var _translation = topicmap.info.childs["dm4.topicmaps.state"].childs["dm4.topicmaps.translation"];
                _translation.childs["dm4.topicmaps.translation_x"].value = translation.x;
                _translation.childs["dm4.topicmaps.translation_y"].value = translation.y;
            }
        });
    </script>

</dom-module>
