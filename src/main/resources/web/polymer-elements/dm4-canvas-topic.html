<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">

<dom-module id="dm4-canvas-topic">

    <style>
        .topic {
            position: absolute;
            padding: 2px 12px 2px 4px;
            min-width:  18px;   /* draggable handle for empty topics */
            min-height: 18px;   /* draggable handle for empty topics */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .topic[selected] {
            box-shadow: 0 0 1em blue;
        }

        img {
            position: absolute;
            bottom: -5px;
            right:  -5px;
            width:  16px;
        }
    </style>

    <template>
        <div id="topic" class="topic" style$="[[_getStyle(topic.pos, size)]]" selected$="[[_getSelected(topic, selection)]]">
            <div>[[topic.value]]</div>
            <img src="[[topic.iconSrc]]">
        </div>
    </template>

    <script>
        Polymer({
            is: "dm4-canvas-topic",

            properties: {

                /**
                 * The rendered topic.
                 */
                topic: {
                    type: Object
                },

                /**
                 * Topicmap selection state.
                 */
                selection: {
                    type: Array
                },

                size: {
                    type: Object
                }
            },

            behaviors: [
                Polymer.IronResizableBehavior
            ],

            listeners: {
                "tap": "_selectTopic",
                "track": "_trackTopic",
                "contextmenu": "_contextmenu",
                "iron-resize": "_topicResized"
            },

            // --- Local DOM ---

            _getStyle: function(pos, size) {
                console.log("_getStyle", pos, size);
                return "left: " + (pos.x - size.width  / 2) + "px; " +
                       "top: "  + (pos.y - size.height / 2) + "px; " +
                       "background-color: hsl(210,100%,90%);";
            },

            _getSelected: function(topic, selection) {
                // console.log("_getSelected", selection, topic.id);
                return DM4.contains(selection, topic.id);
            },

            // -- Event Handling --

            _selectTopic: function() {
                // console.log("topic clicked");
                this.fire("topic-select", {topic: this.topic});
            },

            _contextmenu: function(e) {
                // console.log("_contextmenu", e);
                this.fire("topic-context", {topic: this.topic, x: e.clientX, y: e.clientY});
                e.preventDefault();     // suppress browser's own context menu
            },

            _trackTopic: function(e) {
                // prevent canvas move
                e.stopPropagation();
                // track only the main button
                if (e.detail.sourceEvent.button != 0) {
                    return;
                }
                //
                switch (e.detail.state) {
                case "start":
                    // console.log("topic track start", e);
                    break;
                case "track":
                    this.set("topic.pos", {
                        x: this.topic.pos.x + e.detail.ddx,
                        y: this.topic.pos.y + e.detail.ddy
                    });
                    this.fire("topic-moving", {topic: this.topic});
                    break;
                case "end":
                    // console.log("topic track end");
                    this.fire("topic-move", {topic: this.topic});
                    break;
                }
            },

            _topicResized: function(e) {
                this.size = {
                    width:  this.$.topic.clientWidth,
                    height: this.$.topic.clientHeight
                }
                console.log("_topicResized", this.size, e);
            }
        });
    </script>

</dom-module>
