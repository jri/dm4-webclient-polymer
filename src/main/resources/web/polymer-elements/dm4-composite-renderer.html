<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="dm4-topic-renderer.html">
<link rel="import" href="dm4-multi-renderer.html">
<link rel="import" href="dm4-utils.html">

<dom-module id="dm4-composite-renderer">

    <style>
        :host {
            display: block;
        }
    </style>

    <template>
        <template is="dom-repeat" items="{{_getAssocDefs(topic)}}" as="assocDef">
            <template is="dom-if" if="{{_isOne(assocDef)}}" restamp>
                <dm4-topic-renderer topic="{{_getChildTopic(topic, assocDef)}}" form-mode="{{formMode}}">
                </dm4-topic-renderer>
            </template>
            <template is="dom-if" if="{{_isMany(assocDef)}}" restamp>
                <dm4-multi-renderer topics="{{_getChildTopics(topic, assocDef)}}" form-mode="{{formMode}}">
                </dm4-multi-renderer>
            </template>
        </template>
    </template>

    <script>
        Polymer({
            is: "dm4-composite-renderer",

            properties: {

                /**
                 * The rendered composite topic.
                 */
                topic: Object,

                /**
                 * If `true` a form for the composite topic is rendered.
                 */
                 formMode: {
                     type: Boolean
                 }
            },

            behaviors: [
                DM4.Utils
            ],

            _getAssocDefs: function(topic) {
                // console.log("_getAssocDefs topic", topic);
                return topic && this.getTopicType(topic.type_uri).assocDefs;
            },

            _getChildTopic: function(topic, assocDef) {
                var childTypeUri = assocDef.childTypeUri;
                var childTopic = topic && topic.childs[childTypeUri];
                if (!childTopic && this.formMode) {
                    childTopic = {
                        id: -1,
                        type_uri: childTypeUri,
                        childs: {}
                    }
                }
                // console.log("_getChildTopic topic", topic, "childTypeUri", childTypeUri, "-->", childTopic);
                return childTopic;
            },

            _getChildTopics: function(topic, assocDef) {
                // console.log("_getChildTopics topic", topic, "assocDef", assocDef);
                var childTypeUri = assocDef.childTypeUri;
                var childTopics = topic && topic.childs[childTypeUri];
                if ((!childTopics || childTopics.length == 0) && this.formMode) {
                    childTopics = [
                        {
                            id: -1,
                            type_uri: childTypeUri,
                            childs: {}
                        }
                    ]
                }
                // console.log("_getChildTopic topic", topic, "childTypeUri", childTypeUri, "-->", childTopics);
                return childTopics;
            },

            _isOne: function(assocDef) {
                // console.log("_isOne assocDef", assocDef);
                return assocDef.child_cardinality_uri == "dm4.core.one";
            },

            _isMany: function(assocDef) {
                // console.log("_isMany assocDef", assocDef);
                return assocDef.child_cardinality_uri == "dm4.core.many";
            }
        });
    </script>

</dom-module>
