<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="dm4-topic-renderer.html">
<link rel="import" href="dm4-utils.html">

<dom-module id="dm4-detail-panel">

    <style>
        :host {
            flex: 0 0 25em;
            padding: 1em;
            overflow: auto;
            background-color: #f8f8f8;
        }
    </style>

    <template>
        <h2>[[topic.value]]</h2>
        <dm4-topic-renderer topic="[[topic]]" form-mode="[[formMode]]"></dm4-topic-renderer>
    </template>

    <script>
        Polymer({
            is: "dm4-detail-panel",

            properties: {

                /**
                 * The displayed topic.
                 */
                topic: {
                    type: Object
                },

                /**
                 * If `true` a form for the displayed topic is rendered.
                 */
                formMode: {
                    type: Boolean,
                    value: false
                }
            },

            behaviors: [
                DM4.Utils
            ],

            // ---------------------------------------------------------------------------------------------- Public API

            showTopic: function(topic) {
                this.formMode = false;
                this.topic = topic;
            },

            showForm: function(topic) {
                this.formMode = true;
                this.topic = topic;
            },

            clear: function() {
                this.topic = null;
            },

            finishEdit: function() {
                this.formMode = false;
            },

            buildTopicModel: function(topic) {
                return this._buildTopicModel(topic || this.topic);
            },

            // --------------------------------------------------------------------------------------------- Private API

            _buildTopicModel: function(topic) {
                var topicType = this.getTopicType(topic.type_uri);
                if (topicType.isSimple()) {
                    if (this._isDirty(topic)) {
                        console.log("new", this.getTopicType(topic.type_uri).value, '"' + topic.value + '" old "' +
                            topic.oldValue + '" --> dirty');
                        return {
                            id: topic.id,
                            value: topic.value
                        }
                    } else {
                        console.log("new", this.getTopicType(topic.type_uri).value, '"' + topic.value + '" old "' +
                            topic.oldValue + '" --> clean');
                    }
                } else {
                    var childs = null;
                    var self = this;
                    topicType.assocDefs.forEach(function(assocDef) {
                        var childTypeUri = assocDef.childTypeUri;
                        if (self._isMany(assocDef)) {
                            var childTopics = topic.childs[childTypeUri];
                            childTopics.forEach(function(childTopic) {
                                var value = self._buildTopicModel(childTopic);
                                if (value) {
                                    if (!childs) {
                                        childs = {};
                                    }
                                    if (!childs[childTypeUri]) {
                                        childs[childTypeUri] = [];
                                    }
                                    childs[childTypeUri].push(value);
                                }
                            })
                        } else {
                            var childTopic = topic.childs[childTypeUri];
                            var value = self._buildTopicModel(childTopic);
                            if (value) {
                                if (!childs) {
                                    childs = {};
                                }
                                childs[childTypeUri] = value;
                            }
                        }
                    })
                    if (childs) {
                        return {
                            id: topic.id,
                            childs: childs
                        }
                    }
                }
            },

            _isDirty: function(topic) {
                return topic.value != topic.oldValue;
            },

            _isMany: function(assocDef) {
                return assocDef.child_cardinality_uri == "dm4.core.many";
            }
        });
    </script>

</dom-module>
