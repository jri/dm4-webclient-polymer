<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="dm4-topic-renderer.html">
<link rel="import" href="dm4-utils.html">

<dom-module id="dm4-detail-panel">

    <style>
        :host {
            display: flex;
            flex-flow: column;
            flex: 0 0 25em;
            background-color: #f8f8f8;
        }

        iron-pages {
            display: flex;
            flex-flow: column;
            flex: auto;
            padding: 1em;
        }

        iron-pages > div:nth-child(1) {
            display: flex;
            flex-flow: column;
        }

        #topic-info {
            overflow: auto;
        }

        #buttons {
            flex: none;
        }

        paper-tabs {
            flex: none;
            height: 32px;   /* Override 48px */
        }

        paper-tab:not(.iron-selected) {
            background-color: lightgray;
        }

        paper-tab {
            --paper-tab-content: {
                font-weight: normal !important;     /* Override 700 for tab content of focused tabs */
            }
        }
    </style>

    <template>
        <iron-pages selected="[[selectedTab]]">
            <div>
                <div id="topic-info">
                    <h2>[[topic.value]]</h2>
                    <dm4-topic-renderer topic="[[topic]]" form-mode="[[formMode]]"></dm4-topic-renderer>
                </div>
                <div id="buttons">
                    <template is="dom-if" if="[[topic]]">
                        <template is="dom-if" if="[[formMode]]">
                            <paper-button raised on-tap="_submitForm">OK</paper-button>
                        </template>
                        <template is="dom-if" if="[[!formMode]]">
                            <paper-button raised on-tap="_enterFormMode">Edit</paper-button>
                        </template>
                    </template>
                </div>
            </div>
            <div>
                <h2>[[topic.value]]</h2>
                <h3>Related Topics</h3>
            </div>
        </iron-pages>
        <paper-tabs selected="{{selectedTab}}" no-bar>
            <paper-tab>Info</paper-tab>
            <paper-tab>Related</paper-tab>
        </paper-tabs>
    </template>

    <script>
        Polymer({
            is: "dm4-detail-panel",

            properties: {

                /**
                 * The displayed topic.
                 * If `null`/`undefined` nothing is displayed.
                 */
                topic: {
                    type: Object
                },

                /**
                 * If `true` a form for the topic is rendered.
                 */
                formMode: {
                    type: Boolean,
                    value: false
                },

                /**
                 * The tab currently selected. "0" or "1".
                 */
                selectedTab: {
                    type: String,
                    value: "0"
                }
            },

            behaviors: [
                DM4.Utils
            ],

            // ---------------------------------------------------------------------------------------------- Public API

            showTopic: function(topic) {
                this.leaveFormMode();
                this.topic = topic;
            },

            showForm: function(topic) {
                this._enterFormMode();
                this.topic = topic;
            },

            clear: function() {
                this.topic = null;
            },

            leaveFormMode: function() {
                this.formMode = false;
            },

            buildTopicModel: function(topic) {
                return this._buildTopicModel(topic || this.topic);
            },

            // --------------------------------------------------------------------------------------------- Private API

            _buildTopicModel: function(topic) {
                var topicType = this.getTopicType(topic.type_uri);
                if (topicType.isSimple()) {
                    if (this._isDirty(topic)) {
                        console.log("new", this.getTopicType(topic.type_uri).value, '"' + topic.value + '" old "' +
                            topic.oldValue + '" --> dirty');
                        return {
                            id: topic.id,
                            value: topic.value
                        }
                    } else {
                        console.log("new", this.getTopicType(topic.type_uri).value, '"' + topic.value + '" old "' +
                            topic.oldValue + '" --> clean');
                    }
                } else {
                    var childs = null;
                    var self = this;
                    topicType.assocDefs.forEach(function(assocDef) {
                        var childTypeUri = assocDef.childTypeUri;
                        if (self._isMany(assocDef)) {
                            var childTopics = topic.childs[childTypeUri];
                            childTopics.forEach(function(childTopic) {
                                var value = self._buildTopicModel(childTopic);
                                if (value) {
                                    if (!childs) {
                                        childs = {};
                                    }
                                    if (!childs[childTypeUri]) {
                                        childs[childTypeUri] = [];
                                    }
                                    childs[childTypeUri].push(value);
                                }
                            })
                        } else {
                            var childTopic = topic.childs[childTypeUri];
                            var value = self._buildTopicModel(childTopic);
                            if (value) {
                                if (!childs) {
                                    childs = {};
                                }
                                childs[childTypeUri] = value;
                            }
                        }
                    })
                    if (childs) {
                        return {
                            id: topic.id,
                            childs: childs
                        }
                    }
                }
            },

            _isDirty: function(topic) {
                return topic.value != topic.oldValue;
            },

            _isMany: function(assocDef) {
                return assocDef.child_cardinality_uri == "dm4.core.many";
            },

            // === Event Handler ===

            _enterFormMode: function() {
                this.formMode = true;
                this.async(function() {
                    var paperInput = this.querySelector("paper-input");     // this.$$("paper-input") doesn't work
                    if (paperInput) {
                        console.log("Focusing <paper-input>");
                        paperInput.inputElement.focus();
                    } else {
                        console.log("Focusing <paper-input> failed!");
                    }
                }, 10);
            },

            _submitForm: function() {
                this.fire("topic-edit", {
                    topic: this.topic,
                    submit: true
                });
            },
        });
    </script>

</dom-module>
