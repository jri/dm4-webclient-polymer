<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="dm4-topic-renderer.html">
<link rel="import" href="dm4-utils.html">

<dom-module id="dm4-detail-panel">

    <style>
        :host {
            flex: 0 0 25em;
            padding: 1em;
            overflow: auto;
            background-color: #f8f8f8;
        }
    </style>

    <template>
        <iron-ajax id="getTopic" url="{{_getURL(topicId)}}" params='{"include_childs": true}'
            content-type="application/json" last-response="{{topic}}">
        </iron-ajax>

        <h2>{{topic.value}}</h2>
        <dm4-topic-renderer topic="{{topic}}" form-mode="{{formMode}}"></dm4-topic-renderer>
    </template>

    <script>
        Polymer({
            is: "dm4-detail-panel",

            properties: {

                /**
                 * ID of the displayed topic.
                 * Once changed a new topic is loaded and displayed.
                 */
                topicId: {
                    type: Number,
                    observer: "_topicIdChanged"
                },

                /**
                 * The displayed topic.
                 */
                topic: {
                    type: Object
                },

                /**
                 * If `true` a form for the displayed topic is rendered.
                 */
                formMode: {
                    type: Boolean,
                    value: false
                }
            },

            behaviors: [
                DM4.Utils
            ],

            showForm: function(topic) {
                this.topic = null;
                //
                this.formMode = true;
                this.topic = topic;
            },

            finishEdit: function() {
                this.formMode = false;
            },

            buildTopicModel: function() {
                return this._buildTopicModel(this.topic);
            },

            _buildTopicModel: function(topic) {
                var topicType = this.getTopicType(topic.type_uri);
                if (topicType.isSimple()) {
                    if (this._isDirty(topic)) {
                        console.log(this.getTopicType(topic.type_uri).value, topic.value, topic.oldValue, "--> dirty");
                        return {
                            id: topic.id,
                            value: topic.value
                        }
                    }
                } else {
                    var childs = null;
                    var self = this;
                    topicType.assocDefs.forEach(function(assocDef) {
                        var childTypeUri = assocDef.childTypeUri;
                        var childTopic = topic.childs[childTypeUri];
                        var value = self._buildTopicModel(childTopic);
                        if (value) {
                            if (!childs) {
                                childs = {};
                            }
                            childs[childTypeUri] = value;
                        }
                    })
                    if (childs) {
                        return {
                            id: topic.id,
                            childs: childs
                        }
                    }
                }
            },

            _isDirty: function(topic) {
                return topic.value != topic.oldValue;
            },

            _topicIdChanged: function() {
                this.topic = null;      // empty detail panel before refilling it
                this.$.getTopic.generateRequest();
            },

            _getURL: function(topicId) {
                return "http://localhost:8080/core/topic/" + topicId;
            }
        });
    </script>

</dom-module>
