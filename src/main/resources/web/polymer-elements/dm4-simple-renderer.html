<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="dm4-utils.html">

<dom-module id="dm4-simple-renderer">

    <style>
        :host {
            display: block;
        }

        .label {
            font-size: 75%;
            color: #aaa;
            margin-bottom: -0.1em;
        }

        .value {
            line-height: 160%;
            margin-bottom: 0.8em;
        }
    </style>

    <template>
        <div class="label">{{_getTypeName(topic)}}</div>
        <div class="value" hidden="{{editMode}}" on-tap="_beginEdit">{{topic.value}}</div>
        <paper-input id="input" hidden="{{!editMode}}" on-blur="_finishEdit" value="{{topic.value}}" no-label-float>
        </paper-input>
        <!-- Possible optimization: instantiate paper-input and iron-ajax component only when it edit mode.  -->
        <!-- Tried dom-if template but then focusing input in _beginEdit() fails as input is not yet in DOM. -->
        <iron-ajax id="updateTopic" method="PUT" url="{{_getURL(topic)}}" content-type="application/json"
            body="{{_getBody(topic.value)}}">
        </iron-ajax>
    </template>

    <script>
        Polymer({
            is: "dm4-simple-renderer",

            properties: {

                /**
                 * The rendered topic.
                 * If `null`/`undefined` nothing is rendered.
                 */
                topic: Object,

                /**
                 * If `true` this renderer is in edit mode.
                 */
                editMode: {
                    type: Boolean,
                    value: false
                }
            },

            listeners: {
                change: "_save"
            },

            behaviors: [
                DM4.Utils
            ],

            _beginEdit: function(e) {
                console.log("_beginEdit", this.topic.value);
                this.editMode = true;
                this.$.input.inputElement.focus();
            },

            // Note: _finishEdit() might be called twice but this is no problem.
            // _finishEdit() is called on blur. _finishEdit() also needs to be called by _save() as the save
            // might be triggered by Return key which keeps focus.
            _finishEdit: function(e) {
                console.log("_finishEdit", this.topic.value);
                this.editMode = false;
            },

            _save: function() {
                console.log("_save topic", this.topic.id, '"' + this.topic.value + '"');
                this.$.updateTopic.generateRequest();
                this._finishEdit();
            },

            // --- Calculated Bindings ---

            _getTypeName: function(topic) {
                // console.log("_getTypeName topic", topic);
                return topic && this.getTopicType(topic.type_uri).value;
            },

            _getURL: function(topic) {
                return topic && "http://localhost:8080/core/topic/" + topic.id;
            },

            _getBody: function(topicValue) {
                console.log("_getBody() topic value", topicValue);
                return this.topic && JSON.stringify ({
                    id: this.topic.id,
                    value: topicValue
                });
            }
        });
    </script>

</dom-module>
