<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="dm4-canvas-renderer.html">
<link rel="import" href="dm4-context-menu.html">

<dom-module id="dm4-topicmap-panel">

    <style>
        :host {
            flex: auto;
            position: relative;
            overflow: hidden;
            background-color: #fff;
        }
    </style>

    <template>
        <dm4-canvas-renderer topicmap="[[topicmap]]" translation={{translation}} size="[[size]]" dm4="[[dm4]]">
        </dm4-canvas-renderer>
        <dm4-context-menu id="menu"></dm4-context-menu>
        <iron-ajax id="addTopicToTopicmap"     method="POST" content-type="application/json"></iron-ajax>
        <iron-ajax id="setTopicPosition"       method="PUT"  content-type="application/json"></iron-ajax>
        <iron-ajax id="setTopicmapTranslation" method="PUT"  content-type="application/json"></iron-ajax>
    </template>

    <script>
        Polymer({
            is: "dm4-topicmap-panel",

            properties: {

                /**
                 * The displayed topicmap.
                 */
                topicmap: {
                    type: Object,
                    observer: "_topicmapChanged"
                },

                /**
                 * The topicmap translation in pixel.
                 * An object with `x` and `y` properties.
                 */
                translation: {
                    type: Object,
                    value: {x: 0, y: 0}
                },

                /**
                 * The current size of this topicmap panel.
                 */
                size: {
                    type: Object
                },

                /**
                 * Global state.
                 * See `dm4-webclient`.
                 */
                dm4: {
                    type: Object
                }
            },

            behaviors: [
                Polymer.IronResizableBehavior
            ],

            listeners: {
                "topic-move":    "_storeTopicPosition",
                "topicmap-move": "_storeTopicmapPosition",
                "topic-context": "_showTopicContextMenu",
                "iron-resize":   "_panelResized"
            },

            // ---------------------------------------------------------------------------------------------- Public API

            showTopic: function(topic, select) {
                // TODO: if already in topicmap just set visibility
                topic.view_props = {
                    "dm4.topicmaps.x": Math.floor(this.size.width  * Math.random() - this.translation.x),
                    "dm4.topicmaps.y": Math.floor(this.size.height * Math.random() - this.translation.y),
                    "dm4.topicmaps.visibility": true
                };
                // console.log("showTopic", topic);
                this.push("topicmap.topics", topic);
                //
                if (select) {
                    this.setSelectedTopic(topic.id);
                }
                // update DB
                this.__addTopicToTopicmap(this.topicmap.info.id, topic.id, topic.view_props);
            },

            setSelectedTopic: function(topicId) {
                this.set("topicmap.selection", [topicId]);
            },

            showTopicmap: function(topicmap) {
                this.topicmap = topicmap;
            },

            // --------------------------------------------------------------------------------------------- Private API

            // === Observer ===

            _topicmapChanged: function(topicmap) {
                this.translation = this._getTranslation(topicmap);
                // console.log("_topicmapChanged: setting up canvas translation", this._translation);
            },

            // === Event Handler ===

            _storeTopicPosition: function(e) {
                console.log("_storeTopicPosition");
                var topic = e.detail.topic;
                var viewProps = topic.view_props;
                this.__setTopicPosition(this.topicmap.info.id, topic.id, viewProps["dm4.topicmaps.x"],
                                                                         viewProps["dm4.topicmaps.y"]);
            },

            _storeTopicmapPosition: function(e) {
                var translation = e.detail.translation;
                // console.log("_storeTopicmapPosition", translation, this.translation);
                this._setTranslation(this.topicmap, translation);                                   // update model
                this.__setTopicmapTranslation(this.topicmap.info.id, translation.x, translation.y); // update DB
            },

            _showTopicContextMenu: function(e) {
                var topic = e.detail.topic;
                this.$.menu.removeAll()
                    .addItem({label: "Hide", handler: function() {
                        console.log("hiding topic", topic);
                    }})
                    .addItem({label: "Delete", handler: function() {
                        console.log("deleting topic", topic);
                    }})
                    .show(this, e.detail.x, e.detail.y);
            },

            _panelResized: function(e) {
                this.size = {
                    width: this.clientWidth,
                    height: this.clientHeight
                }
            },

            // === Requests ===

            __addTopicToTopicmap: function(topicmapId, topicId, viewProps) {
                this.$.addTopicToTopicmap.url = "http://localhost:8080/topicmap/" + topicmapId + "/topic/" + topicId;
                this.$.addTopicToTopicmap.body = JSON.stringify(viewProps);
                this.$.addTopicToTopicmap.generateRequest();
            },

            __setTopicPosition: function(topicmapId, topicId, x, y) {
                this.$.setTopicPosition.url = "http://localhost:8080/topicmap/" + topicmapId + "/topic/" + topicId +
                    "/" + x + "/" + y;
                this.$.setTopicPosition.generateRequest();
            },

            __setTopicmapTranslation: function(topicmapId, x, y) {
                this.$.setTopicmapTranslation.url = "http://localhost:8080/topicmap/" + topicmapId + "/translation/" +
                    x + "/" + y;
                this.$.setTopicmapTranslation.generateRequest();
            },

            // === Modell Access ===

            _getTranslation: function(topicmap) {
                var _translation = topicmap.info.childs["dm4.topicmaps.state"].childs["dm4.topicmaps.translation"];
                return {
                    x: _translation.childs["dm4.topicmaps.translation_x"].value,
                    y: _translation.childs["dm4.topicmaps.translation_y"].value
                }
            },

            _setTranslation: function(topicmap, translation) {
                var _translation = topicmap.info.childs["dm4.topicmaps.state"].childs["dm4.topicmaps.translation"];
                _translation.childs["dm4.topicmaps.translation_x"].value = translation.x;
                _translation.childs["dm4.topicmaps.translation_y"].value = translation.y;
            }
        });
    </script>

</dom-module>
