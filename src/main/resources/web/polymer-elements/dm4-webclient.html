<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-meta/iron-meta.html">
<link rel="import" href="dm4-toolbar.html">
<link rel="import" href="dm4-topicmap-panel.html">
<link rel="import" href="dm4-detail-panel.html">
<link rel="import" href="dm4-typecache.html">

<dom-module id="dm4-webclient">

    <style>
        :host {
            font-family: "Roboto", "Noto", sans-serif;
            display: flex;
            flex-flow: column;
            height: 100%;
        }
        div {
            display: flex;
            flex: auto;
        }
    </style>

    <template>
        <dm4-toolbar dm4="[[dm4]]"></dm4-toolbar>
        <div>
            <dm4-topicmap-panel></dm4-topicmap-panel>
            <dm4-detail-panel></dm4-detail-panel>
        </div>

        <dm4-typecache dm4="{{dm4}}"></dm4-typecache>
        <iron-meta key="dm4" value="[[dm4]]"></iron-meta>

        <iron-ajax id="createTopic" method="POST" url="http://localhost:8080/core/topic" content-type="application/json"
            on-response="_showTopic">
        </iron-ajax>
        <iron-ajax id="updateTopic" method="PUT" content-type="application/json"></iron-ajax>
    </template>

    <script>
        Polymer({
            is: "dm4-webclient",

            properties: {

                /**
                 * Global state.
                 */
                dm4: {
                    type: Object,
                    value: {
                        topicTypesArray: [],
                        assocTypesArray: [],
                        topicTypes: {},
                        assocTypes: {}
                    }
                }
            },

            listeners: {
                "topic-select": "_topicSelected",
                "topicmap-select": "_topicmapSelected",
                "topic-create": "_createTopic",
                "topic-edit": "_topicEdited"
            },

            _topicSelected: function(e) {
                this.$$("dm4-detail-panel").topicId = e.detail.topic.id;
            },

            _topicmapSelected: function(e) {
                this.$$("dm4-topicmap-panel").topicmapId = e.detail.topicmap.id;
            },

            _createTopic: function(e) {
                console.log("Creating topic of type \"" + e.detail.topicType.uri + "\"");
                this.$.createTopic.body = JSON.stringify({type_uri: e.detail.topicType.uri});
                this.$.createTopic.generateRequest();
            },

            _topicEdited: function(e) {
                if (this.$$("dm4-detail-panel").formMode) {
                    if (e.detail.submit) {
                        console.log("Saving entire form");
                        var topicModel = this.$$("dm4-detail-panel").buildTopicModel();
                        console.log(topicModel);
                        this._updateTopic(topicModel);
                        this.$$("dm4-detail-panel").finishEdit();
                    } else {
                        console.log("_topicEdited --> ignoring");
                    }
                } else {
                    var topic = e.detail.topic;
                    console.log("Saving single topic", topic.id, '"' + topic.value + '"', e);
                    this._updateTopic({
                        id: topic.id,
                        value: topic.value
                    });
                    e.target.finishEdit();
                }
            },

            _updateTopic: function(topic) {
                this.$.updateTopic.url = "http://localhost:8080/core/topic/" + topic.id;
                this.$.updateTopic.body = JSON.stringify(topic);
                this.$.updateTopic.generateRequest();
            },

            _showTopic: function(e) {
                var topic = e.detail.response;
                this.$$("dm4-topicmap-panel").showTopic(topic);
                this.$$("dm4-detail-panel").showForm(topic);
            }
        });
    </script>

</dom-module>
