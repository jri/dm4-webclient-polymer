<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="dm4-toolbar.html">
<link rel="import" href="dm4-topicmap-panel.html">
<link rel="import" href="dm4-detail-panel.html">

<dom-module id="dm4-webclient">

    <style>
        :host {
            font-family: "Roboto", "Noto", sans-serif;
            display: flex;
            flex-flow: column;
            height: 100%;
        }
        div {
            display: flex;
            flex: auto;
        }
    </style>

    <template>
        <iron-ajax auto url="http://localhost:8080/core/topictype/all" content-type="application/json"
            last-response="{{typeDefs.topicTypes}}">
        </iron-ajax>
        <iron-ajax auto url="http://localhost:8080/core/assoctype/all" content-type="application/json"
            last-response="{{typeDefs.assocTypes}}">
        </iron-ajax>

        <dm4-toolbar></dm4-toolbar>
        <div>
            <dm4-topicmap-panel></dm4-topicmap-panel>
            <dm4-detail-panel topic-types={{topicTypes}} assoc-types={{assocTypes}}></dm4-detail-panel>
        </div>
    </template>

    <script>
        Polymer({
            is: "dm4-webclient",

            properties:  {
                typeDefs: {     // intermediate
                    type: Object,
                    value: {
                        topicTypes: [],
                        assocTypes: []
                    }
                },
                topicTypes: {
                    type: Object,
                    value: {}
                },
                assocTypes: {
                    type: Object,
                    value: {}
                }
            },

            observers: [
                "_hashTopicTypes(typeDefs.topicTypes)",
                "_hashAssocTypes(typeDefs.assocTypes)"
            ],

            listeners: {
                "topic-select": "_topicSelected",
                "topicmap-select": "_topicmapSelected"
            },

            // ---

            _topicSelected: function(e) {
                this.$$("dm4-detail-panel").topicId = e.detail.topic.id;
            },

            _topicmapSelected: function(e) {
                this.$$("dm4-topicmap-panel").topicmapId = e.detail.topicmap.id;
            },

            // --- Helper ---

            _hashTopicTypes: function(topicTypes) {
                // console.log("_hashTopicTypes", topicTypes);
                this._hash(topicTypes, this.topicTypes, DM4.TopicType);
            },

            _hashAssocTypes: function(assocTypes) {
                // console.log("_hashAssocTypes", assocTypes);
                this._hash(assocTypes, this.assocTypes, DM4.AssociationType);
            },

            _hash: function(array, object, constructor) {
                for (var i = 0, item; item = array[i]; i++) {
                    object[item.uri] = new constructor(item);
                }
            }
        });
    </script>

</dom-module>
